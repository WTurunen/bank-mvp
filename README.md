# Invoice Management

A full-stack invoice management application. Create invoices for clients, track their status through a draft → sent → paid lifecycle, generate print-ready previews, and monitor outstanding and overdue amounts from a single dashboard.

## Tech Stack

| Layer | Choice | Notes |
|---|---|---|
| Framework | Next.js 16 (App Router) | Server Actions for mutations, server components for data fetching |
| Database | PostgreSQL via Prisma | Decimal columns for monetary values; SQLite for local dev |
| UI | shadcn/ui + Tailwind CSS v4 | Radix primitives for accessible select/label components |
| Testing | Vitest + React Testing Library | happy-dom environment; 139 tests across validation, actions, components, and pages |
| CI | GitHub Actions | PostgreSQL 16 service container; lint → typecheck → test → build |

## Getting Started

```bash
npm install
npx prisma generate      # Generate Prisma client
npx prisma db push       # Create tables (uses DATABASE_URL from .env)
npx prisma db seed       # Populate with sample clients and invoices
npm run dev              # Start dev server at http://localhost:3000
```

For a fresh database, set `DATABASE_URL` in `.env` to a PostgreSQL connection string (or leave it unset to fall back to SQLite for local development).

## Project Structure

```
src/
├── app/
│   ├── actions/
│   │   ├── invoices.ts      # Invoice CRUD server actions
│   │   └── clients.ts       # Client CRUD + archive/restore server actions
│   ├── invoices/
│   │   ├── new/page.tsx     # Create invoice
│   │   └── [id]/
│   │       ├── page.tsx     # Edit invoice
│   │       └── preview/     # Print-ready invoice preview
│   ├── clients/
│   │   ├── page.tsx         # Client list
│   │   ├── new/page.tsx     # Create client
│   │   └── [id]/page.tsx    # Edit / archive client
│   └── page.tsx             # Dashboard
├── components/
│   ├── invoice-form.tsx     # Shared create/edit form with dynamic line items
│   ├── client-form.tsx      # Client create/edit form
│   ├── client-selector.tsx  # Client dropdown with inline detail card
│   └── ui/                  # shadcn primitives (button, table, badge, etc.)
└── lib/
    ├── db.ts                # Singleton Prisma client
    ├── validation.ts        # Invoice field validation
    ├── clients-validation.ts
    └── utils.ts             # formatCurrency, formatDate, calculateInvoiceTotal
```

## Architecture Decisions

### Server Actions as the mutation layer

All writes go through Next.js Server Actions (`src/app/actions/`). This keeps the API surface implicit — no route handlers, no request parsing, no CSRF tokens to manage. Each action calls `revalidatePath` after mutating, which is the only cache invalidation mechanism in the app. Any page that reads data affected by a mutation must be listed in that action's revalidation calls (e.g., `createClient` revalidates both `/clients` and `/invoices/new`, because both pages fetch the client list).

### Client snapshot on invoices

When an invoice is created or edited, the client's name, email, phone, and address are copied into columns on the invoice row. The invoice retains a `clientId` foreign key for filtering and linking, but the snapshot fields are what get rendered — on the invoice detail, on the preview, and in the dashboard table. This means editing or archiving a client never retroactively alters historical invoices.

### Soft delete for clients

Clients are never hard-deleted. An `archivedAt` timestamp marks them as inactive. Archived clients disappear from the client list and from the invoice form's client selector, but their existing invoices remain intact and queryable. `restoreClient` clears the timestamp to bring them back.

### Decimal for money

`LineItem.quantity` and `LineItem.unitPrice` are stored as `Decimal` in PostgreSQL, avoiding floating-point rounding errors on currency arithmetic. The Prisma client returns these as `Decimal` objects; the action layer calls `.toNumber()` before passing them to components, keeping the boundary clean.

### Invoice numbering

Invoice numbers (`INV-001`, `INV-002`, …) are generated by querying the highest existing `invoiceNumber` and incrementing. This is intentionally simple — correct under normal single-user load, and avoids the complexity of a sequence or counter table for an MVP.

## Data Model

```
Client 1 ──────── * Invoice * ──────── 1+ LineItem
  (id, name,        (id, invoiceNumber,      (id, description,
   email,            clientId, snapshot...,    quantity,
   phone,            status, dates,           unitPrice)
   address,          notes)
   archivedAt)
```

**Status flow:** `draft` → `sent` → `paid`. The dashboard computes an `overdue` display state for any invoice that is `sent` with a `dueDate` in the past — this is never stored, only derived at render time.

## Running Tests

```bash
npm run test:run          # Full suite (once)
npm run test              # Watch mode
npx vitest run src/lib/utils.test.ts   # Single file
```

Tests cover four layers:

- **Validation** — pure functions, no I/O. Every valid/invalid field combination for invoices and clients.
- **Server actions** — client actions tested with a mocked Prisma client. Verifies create/update/archive/restore logic and duplicate-email error handling.
- **Components** — `InvoiceForm`, `ClientForm`, and `ClientSelector` rendered with Testing Library. Covers form submission, validation feedback, client selection populating snapshot fields, and error states from failed server actions.
- **Pages** — the clients list page, tested with mocked server actions to verify rendering and interaction.

## CI Pipeline

Defined in `.github/workflows/ci.yml`. Runs on every push and pull request to `master`:

1. **Lint** — ESLint with `eslint-config-next`
2. **Typecheck** — `tsc --noEmit`
3. **Tests** — full Vitest suite
4. **DB push** — applies the Prisma schema to a fresh PostgreSQL 16 container
5. **Build** — production `next build` against that database

All five steps must pass. The PostgreSQL service container is configured with health checks so the database is ready before any step that needs it.

## Available Scripts

| Script | What it does |
|---|---|
| `npm run dev` | Development server |
| `npm run build` | Production build |
| `npm run lint` | ESLint |
| `npm run typecheck` | TypeScript type check |
| `npm run test` | Vitest in watch mode |
| `npm run test:run` | Vitest single run |
