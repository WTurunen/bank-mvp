generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  name        String
  email       String    @unique
  phone       String?
  address     String?
  archivedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  invoices    Invoice[]

  @@index([userId, archivedAt])
  @@index([archivedAt])
}

model Invoice {
  id            String     @id @default(cuid())
  userId        String
  user          User       @relation(fields: [userId], references: [id])
  invoiceNumber String     @unique

  // Reference to client (nullable for migration safety)
  clientId           String?
  client             Client?   @relation(fields: [clientId], references: [id])

  // Snapshot fields (copied from client at invoice creation)
  clientName         String
  clientEmail        String
  clientPhone        String?
  clientAddress      String?

  status        String     @default("draft") // draft, sent, paid
  issueDate     DateTime   @default(now())
  dueDate       DateTime
  notes         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  version       Int        @default(0)
  archivedAt    DateTime?
  lineItems     LineItem[]

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@index([createdAt])
}

model LineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal
  unitPrice   Decimal
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  clients       Client[]
  invoices      Invoice[]
}

model InvoiceCounter {
  id        String   @id @default("default")
  counter   Int      @default(0)
  updatedAt DateTime @updatedAt
}
