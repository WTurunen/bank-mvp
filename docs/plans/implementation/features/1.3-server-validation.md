# Feature 1.3: Server-Side Validation

**Track:** 1 - Security (BLOCKING)
**Dependencies:** None
**Estimated Tasks:** 12 atomic tasks

## Overview

Add Zod schemas for server-side validation. Currently the app trusts client-submitted data, which is a security vulnerability. All server actions must validate input before database operations.

---

## Task List

- [ ] 1.3.1a Install zod dependency
- [ ] 1.3.2a Create client schema
- [ ] 1.3.2b Create line item schema
- [ ] 1.3.2c Create invoice schema
- [ ] 1.3.2d Create status enum validation
- [ ] 1.3.3a Add validation to createClient
- [ ] 1.3.3b Add validation to updateClient
- [ ] 1.3.4a Add validation to createInvoice
- [ ] 1.3.4b Add validation to updateInvoice
- [ ] 1.3.4c Add validation to updateInvoiceStatus
- [ ] 1.3.5a Create validation error response type
- [ ] 1.3.5b Update actions to return validation errors

---

## Task Details

### 1.3.1a Install zod dependency

**Action:** Run command
**Command:**
```bash
npm install zod
```
**Verify:**
```bash
npm ls zod
```
Should show `zod@3.x.x`

**Commit:** `feat(1.3.1a): install zod validation library`

---

### 1.3.2a Create client schema

**File:** `src/lib/schemas.ts`
**Action:** Create new file

**Code:**
```typescript
import { z } from "zod";

export const clientSchema = z.object({
  name: z
    .string()
    .min(1, "Name is required")
    .max(200, "Name must be 200 characters or less"),
  email: z
    .string()
    .min(1, "Email is required")
    .email("Invalid email format")
    .max(254, "Email must be 254 characters or less"),
  phone: z
    .string()
    .max(50, "Phone must be 50 characters or less")
    .optional()
    .nullable(),
  address: z
    .string()
    .max(500, "Address must be 500 characters or less")
    .optional()
    .nullable(),
});

export type ClientSchema = z.infer<typeof clientSchema>;
```

**Verify:** File exists and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(1.3.2a): create Zod schema for client validation`

---

### 1.3.2b Create line item schema

**File:** `src/lib/schemas.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
export const lineItemSchema = z.object({
  description: z
    .string()
    .min(1, "Description is required")
    .max(500, "Description must be 500 characters or less"),
  quantity: z
    .number()
    .positive("Quantity must be greater than zero")
    .max(999999, "Quantity is too large"),
  unitPrice: z
    .number()
    .min(0, "Price cannot be negative")
    .max(999999999, "Price is too large"),
});

export type LineItemSchema = z.infer<typeof lineItemSchema>;
```

**Verify:** Schema added and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(1.3.2b): create Zod schema for line item validation`

---

### 1.3.2c Create invoice schema

**File:** `src/lib/schemas.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
export const invoiceSchema = z.object({
  clientId: z.string().optional(),
  clientName: z
    .string()
    .min(1, "Client name is required")
    .max(200, "Client name must be 200 characters or less"),
  clientEmail: z
    .string()
    .min(1, "Client email is required")
    .email("Invalid client email format")
    .max(254, "Client email must be 254 characters or less"),
  clientPhone: z
    .string()
    .max(50, "Phone must be 50 characters or less")
    .optional()
    .nullable(),
  clientAddress: z
    .string()
    .max(500, "Address must be 500 characters or less")
    .optional()
    .nullable(),
  dueDate: z.string().min(1, "Due date is required"),
  notes: z
    .string()
    .max(2000, "Notes must be 2000 characters or less")
    .optional()
    .nullable(),
  lineItems: z
    .array(lineItemSchema)
    .min(1, "At least one line item is required"),
});

export type InvoiceSchema = z.infer<typeof invoiceSchema>;
```

**Verify:** Schema added and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(1.3.2c): create Zod schema for invoice validation`

---

### 1.3.2d Create status enum validation

**File:** `src/lib/schemas.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
export const VALID_STATUSES = ["draft", "sent", "paid"] as const;

export const invoiceStatusSchema = z.enum(VALID_STATUSES, {
  errorMap: () => ({ message: "Status must be draft, sent, or paid" }),
});

export type InvoiceStatus = z.infer<typeof invoiceStatusSchema>;
```

**Verify:** Schema added and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(1.3.2d): create Zod schema for invoice status enum`

---

### 1.3.3a Add validation to createClient

**File:** `src/app/actions/clients.ts`
**Action:** Modify createClient function

**Add import at top:**
```typescript
import { clientSchema } from "@/lib/schemas";
```

**Find this code in createClient (after userId line if 1.2 is done, otherwise at start of try block):**
```typescript
    const client = await db.client.create({
```

**Add before that line:**
```typescript
    const validated = clientSchema.safeParse(data);
    if (!validated.success) {
      const firstError = validated.error.errors[0];
      throw new Error(firstError.message);
    }

```

**Verify:** createClient validates input. Run `npm run typecheck`

**Commit:** `feat(1.3.3a): add Zod validation to createClient action`

---

### 1.3.3b Add validation to updateClient

**File:** `src/app/actions/clients.ts`
**Action:** Modify updateClient function

**Find the start of the try block in updateClient and add:**
```typescript
    const validated = clientSchema.safeParse(data);
    if (!validated.success) {
      const firstError = validated.error.errors[0];
      throw new Error(firstError.message);
    }

```

**Verify:** updateClient validates input. Run `npm run typecheck`

**Commit:** `feat(1.3.3b): add Zod validation to updateClient action`

---

### 1.3.4a Add validation to createInvoice

**File:** `src/app/actions/invoices.ts`
**Action:** Modify createInvoice function

**Add import at top:**
```typescript
import { invoiceSchema } from "@/lib/schemas";
```

**Find this code in createInvoice:**
```typescript
export async function createInvoice(data: InvoiceInput) {
  const invoiceNumber = await generateInvoiceNumber();
```

**Add between those lines:**
```typescript
  const validated = invoiceSchema.safeParse(data);
  if (!validated.success) {
    const firstError = validated.error.errors[0];
    throw new Error(firstError.message);
  }

```

**Verify:** createInvoice validates input. Run `npm run typecheck`

**Commit:** `feat(1.3.4a): add Zod validation to createInvoice action`

---

### 1.3.4b Add validation to updateInvoice

**File:** `src/app/actions/invoices.ts`
**Action:** Modify updateInvoice function

**Find the start of updateInvoice function and add validation:**
```typescript
export async function updateInvoice(id: string, data: InvoiceInput) {
  const validated = invoiceSchema.safeParse(data);
  if (!validated.success) {
    const firstError = validated.error.errors[0];
    throw new Error(firstError.message);
  }

  // ... rest of function
```

**Verify:** updateInvoice validates input. Run `npm run typecheck`

**Commit:** `feat(1.3.4b): add Zod validation to updateInvoice action`

---

### 1.3.4c Add validation to updateInvoiceStatus

**File:** `src/app/actions/invoices.ts`
**Action:** Modify updateInvoiceStatus function

**Add import (if not already added):**
```typescript
import { invoiceSchema, invoiceStatusSchema } from "@/lib/schemas";
```

**Find this code:**
```typescript
export async function updateInvoiceStatus(id: string, status: string) {
  await db.invoice.update({
```

**Replace with:**
```typescript
export async function updateInvoiceStatus(id: string, status: string) {
  const validated = invoiceStatusSchema.safeParse(status);
  if (!validated.success) {
    throw new Error("Status must be draft, sent, or paid");
  }

  await db.invoice.update({
```

**Verify:** updateInvoiceStatus validates status. Run `npm run typecheck`

**Commit:** `feat(1.3.4c): add Zod validation to updateInvoiceStatus action`

---

### 1.3.5a Create validation error response type

**File:** `src/lib/schemas.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
export type ActionResult<T = void> =
  | { success: true; data: T }
  | { success: false; error: string; field?: string };

export function validationError(error: z.ZodError): ActionResult<never> {
  const firstError = error.errors[0];
  return {
    success: false,
    error: firstError.message,
    field: firstError.path.join("."),
  };
}
```

**Verify:** Types added and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(1.3.5a): create validation error response type`

---

### 1.3.5b Update actions to return validation errors

**File:** `src/app/actions/clients.ts`
**Action:** Modify createClient to return ActionResult

**Change the function signature and return type:**

**Find:**
```typescript
export async function createClient(data: ClientInput): Promise<string> {
```

**Replace with:**
```typescript
import { clientSchema, ActionResult, validationError } from "@/lib/schemas";

export async function createClient(data: ClientInput): Promise<ActionResult<string>> {
```

**Update validation block:**
```typescript
  const validated = clientSchema.safeParse(data);
  if (!validated.success) {
    return validationError(validated.error);
  }
```

**Update success return:**
```typescript
    return { success: true, data: client.id };
```

**Update error handling:**
```typescript
  } catch (error: unknown) {
    if (
      error &&
      typeof error === "object" &&
      "code" in error &&
      error.code === "P2002"
    ) {
      return { success: false, error: "A client with this email already exists", field: "email" };
    }
    throw error;
  }
```

**Note:** Also update updateClient, archiveClient, restoreClient with similar pattern.

**Verify:** Actions return ActionResult type. Run `npm run typecheck`

**Commit:** `feat(1.3.5b): update client actions to return ActionResult with validation errors`

---

## Progress Log

| Timestamp | Agent | Action | Task | Commit |
|-----------|-------|--------|------|--------|
| | | | | |
