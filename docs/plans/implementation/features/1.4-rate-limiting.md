# Feature 1.4: Rate Limiting

**Track:** 1 - Security (BLOCKING)
**Dependencies:** 1.1 Authentication (must be complete)
**Estimated Tasks:** 8 atomic tasks

## Overview

Add rate limiting to prevent abuse and DoS attacks. Authenticated users get higher limits than unauthenticated requests.

---

## Task List

- [ ] 1.4.1a Install rate limiting dependencies
- [ ] 1.4.2a Create rate limit configuration
- [ ] 1.4.2b Create rate limit utility function
- [ ] 1.4.3a Add rate limiting to middleware
- [ ] 1.4.3b Configure rate limit for auth routes
- [ ] 1.4.3c Configure rate limit for API routes
- [ ] 1.4.4a Add rate limit headers to responses
- [ ] 1.4.4b Create rate limit exceeded page

---

## Task Details

### 1.4.1a Install rate limiting dependencies

**Action:** Run command

**Option A - Using Upstash Redis (recommended for production):**
```bash
npm install @upstash/ratelimit @upstash/redis
```

**Option B - Using in-memory limiter (simpler, for single instance):**
```bash
npm install limiter
```

**This plan uses Option B for simplicity. For production with multiple instances, use Option A.**

**Verify:**
```bash
npm ls limiter
```
Should show `limiter@2.x.x`

**Commit:** `feat(1.4.1a): install rate limiting dependency`

---

### 1.4.2a Create rate limit configuration

**File:** `src/lib/rate-limit.ts`
**Action:** Create new file

**Code:**
```typescript
export const RATE_LIMIT_CONFIG = {
  // Authenticated users: 100 requests per minute
  authenticated: {
    tokens: 100,
    interval: 60 * 1000, // 1 minute in ms
  },
  // Unauthenticated users: 20 requests per minute
  unauthenticated: {
    tokens: 20,
    interval: 60 * 1000,
  },
  // Login/register: 5 attempts per minute (prevent brute force)
  auth: {
    tokens: 5,
    interval: 60 * 1000,
  },
} as const;
```

**Verify:** File exists and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(1.4.2a): create rate limit configuration`

---

### 1.4.2b Create rate limit utility function

**File:** `src/lib/rate-limit.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
import { RateLimiter } from "limiter";

// Store limiters by key (IP or user ID)
const limiters = new Map<string, RateLimiter>();

type RateLimitType = keyof typeof RATE_LIMIT_CONFIG;

function getLimiter(key: string, type: RateLimitType): RateLimiter {
  const cacheKey = `${type}:${key}`;

  if (!limiters.has(cacheKey)) {
    const config = RATE_LIMIT_CONFIG[type];
    limiters.set(
      cacheKey,
      new RateLimiter({
        tokensPerInterval: config.tokens,
        interval: config.interval,
      })
    );
  }

  return limiters.get(cacheKey)!;
}

export type RateLimitResult = {
  success: boolean;
  remaining: number;
  reset: number;
};

export async function checkRateLimit(
  key: string,
  type: RateLimitType
): Promise<RateLimitResult> {
  const limiter = getLimiter(key, type);
  const remaining = await limiter.removeTokens(1);

  return {
    success: remaining >= 0,
    remaining: Math.max(0, Math.floor(remaining)),
    reset: Date.now() + RATE_LIMIT_CONFIG[type].interval,
  };
}

// Clean up old limiters periodically (every 5 minutes)
setInterval(() => {
  const now = Date.now();
  for (const [key, limiter] of limiters.entries()) {
    // Remove limiters that haven't been used in 10 minutes
    if (limiter.getTokensRemaining() === limiter.tokenBucket.tokensPerInterval) {
      limiters.delete(key);
    }
  }
}, 5 * 60 * 1000);
```

**Verify:** File compiles. Run `npm run typecheck`

**Commit:** `feat(1.4.2b): create rate limit utility function`

---

### 1.4.3a Add rate limiting to middleware

**File:** `src/middleware.ts`
**Action:** Modify existing file

**Add import at top:**
```typescript
import { checkRateLimit } from "@/lib/rate-limit";
```

**Add helper function before the default export:**
```typescript
function getClientIP(req: Request): string {
  const forwarded = req.headers.get("x-forwarded-for");
  if (forwarded) {
    return forwarded.split(",")[0].trim();
  }
  return "unknown";
}
```

**Modify the auth callback to add rate limiting:**

**Find:**
```typescript
export default auth((req) => {
  const isLoggedIn = !!req.auth;
```

**Replace with:**
```typescript
export default auth(async (req) => {
  const isLoggedIn = !!req.auth;
  const ip = getClientIP(req);
  const rateLimitKey = isLoggedIn ? req.auth!.user!.id : ip;
  const rateLimitType = isLoggedIn ? "authenticated" : "unauthenticated";

  const rateLimit = await checkRateLimit(rateLimitKey, rateLimitType);

  if (!rateLimit.success) {
    return new NextResponse("Too Many Requests", {
      status: 429,
      headers: {
        "Retry-After": String(Math.ceil((rateLimit.reset - Date.now()) / 1000)),
        "X-RateLimit-Remaining": String(rateLimit.remaining),
      },
    });
  }
```

**Verify:** Middleware applies rate limiting. Run `npm run typecheck`

**Commit:** `feat(1.4.3a): add rate limiting to middleware`

---

### 1.4.3b Configure rate limit for auth routes

**File:** `src/middleware.ts`
**Action:** Modify to use stricter limits for auth routes

**Add after the isAuthPage check:**
```typescript
  // Use stricter rate limit for auth pages (login/register)
  if (isAuthPage && !isLoggedIn) {
    const authRateLimit = await checkRateLimit(ip, "auth");
    if (!authRateLimit.success) {
      return new NextResponse("Too many login attempts. Please try again later.", {
        status: 429,
        headers: {
          "Retry-After": String(Math.ceil((authRateLimit.reset - Date.now()) / 1000)),
        },
      });
    }
  }
```

**Verify:** Auth routes have stricter rate limits. Run `npm run typecheck`

**Commit:** `feat(1.4.3b): configure stricter rate limits for auth routes`

---

### 1.4.3c Configure rate limit for API routes

**File:** `src/middleware.ts`
**Action:** Ensure API routes are also rate limited

**The current middleware config already catches API routes. Verify the matcher includes them:**

```typescript
export const config = {
  matcher: [
    "/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
  ],
};
```

**This matcher catches all routes except static files, including `/api/*` routes.**

**Verify:** API routes are included in middleware matcher

**Commit:** `feat(1.4.3c): verify API routes are rate limited`

---

### 1.4.4a Add rate limit headers to responses

**File:** `src/middleware.ts`
**Action:** Add rate limit headers to successful responses

**Find the final return statement:**
```typescript
  return NextResponse.next();
```

**Replace with:**
```typescript
  const response = NextResponse.next();
  response.headers.set("X-RateLimit-Remaining", String(rateLimit.remaining));
  response.headers.set("X-RateLimit-Reset", String(rateLimit.reset));
  return response;
```

**Verify:** Responses include rate limit headers. Run `npm run typecheck`

**Commit:** `feat(1.4.4a): add rate limit headers to responses`

---

### 1.4.4b Create rate limit exceeded page

**File:** `src/app/rate-limited/page.tsx`
**Action:** Create new file (create directory if needed)

**Code:**
```typescript
export default function RateLimitedPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow text-center">
        <div>
          <h2 className="text-3xl font-bold text-gray-900">
            Too Many Requests
          </h2>
          <p className="mt-4 text-gray-600">
            You&apos;ve made too many requests. Please wait a moment and try again.
          </p>
        </div>
        <a
          href="/"
          className="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          Go to Dashboard
        </a>
      </div>
    </div>
  );
}
```

**Verify:** Page exists and renders correctly

**Commit:** `feat(1.4.4b): create rate limit exceeded page`

---

## Progress Log

| Timestamp | Agent | Action | Task | Commit |
|-----------|-------|--------|------|--------|
| | | | | |
