# Feature 3.2: Error Monitoring

**Track:** 3 - Reliability
**Dependencies:** None
**Estimated Tasks:** 10 atomic tasks

## Overview

Add Sentry for error monitoring and alerting. Errors should be captured with context to enable debugging.

---

## Task List

- [ ] 3.2.1a Install Sentry SDK
- [ ] 3.2.1b Install Sentry Next.js plugin
- [ ] 3.2.2a Create Sentry client configuration
- [ ] 3.2.2b Create Sentry server configuration
- [ ] 3.2.2c Create Sentry edge configuration
- [ ] 3.2.3a Update next.config.js for Sentry
- [ ] 3.2.3b Configure source maps upload
- [ ] 3.2.4a Create error boundary component
- [ ] 3.2.4b Add global error page
- [ ] 3.2.5a Add user context to Sentry errors

---

## Task Details

### 3.2.1a Install Sentry SDK

**Action:** Run command
**Command:**
```bash
npm install @sentry/nextjs
```
**Verify:**
```bash
npm ls @sentry/nextjs
```
Should show `@sentry/nextjs@8.x.x`

**Commit:** `feat(3.2.1a): install Sentry SDK`

---

### 3.2.1b Install Sentry Next.js plugin

**Action:** Already included with @sentry/nextjs

**Verify:** @sentry/nextjs package installed

**Commit:** No separate commit needed

---

### 3.2.2a Create Sentry client configuration

**File:** `sentry.client.config.ts`
**Action:** Create new file in project root

**Code:**
```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,

  // Performance monitoring
  tracesSampleRate: process.env.NODE_ENV === "production" ? 0.1 : 1.0,

  // Session replay (optional, can remove if not needed)
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,

  // Only enable in production
  enabled: process.env.NODE_ENV === "production",

  // Environment tag
  environment: process.env.NODE_ENV,

  // Filter out noisy errors
  ignoreErrors: [
    // Browser extensions
    /^chrome-extension:\/\//,
    /^moz-extension:\/\//,
    // Network errors users can't control
    "Network request failed",
    "Failed to fetch",
    "Load failed",
  ],
});
```

**Verify:** File exists in project root

**Commit:** `feat(3.2.2a): create Sentry client configuration`

---

### 3.2.2b Create Sentry server configuration

**File:** `sentry.server.config.ts`
**Action:** Create new file in project root

**Code:**
```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.SENTRY_DSN,

  // Performance monitoring
  tracesSampleRate: process.env.NODE_ENV === "production" ? 0.1 : 1.0,

  // Only enable in production
  enabled: process.env.NODE_ENV === "production",

  // Environment tag
  environment: process.env.NODE_ENV,
});
```

**Verify:** File exists in project root

**Commit:** `feat(3.2.2b): create Sentry server configuration`

---

### 3.2.2c Create Sentry edge configuration

**File:** `sentry.edge.config.ts`
**Action:** Create new file in project root

**Code:**
```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.SENTRY_DSN,

  // Performance monitoring
  tracesSampleRate: process.env.NODE_ENV === "production" ? 0.1 : 1.0,

  // Only enable in production
  enabled: process.env.NODE_ENV === "production",

  // Environment tag
  environment: process.env.NODE_ENV,
});
```

**Verify:** File exists in project root

**Commit:** `feat(3.2.2c): create Sentry edge configuration`

---

### 3.2.3a Update next.config.js for Sentry

**File:** `next.config.ts` (or `next.config.js`)
**Action:** Wrap with Sentry

**If file is next.config.ts:**
```typescript
import { withSentryConfig } from "@sentry/nextjs";

const nextConfig = {
  // Your existing config
};

export default withSentryConfig(nextConfig, {
  // Sentry build options
  org: process.env.SENTRY_ORG,
  project: process.env.SENTRY_PROJECT,

  // Suppress source map upload logs
  silent: true,

  // Upload source maps only in production
  disableSourceMapUpload: process.env.NODE_ENV !== "production",
});
```

**If file is next.config.js or doesn't exist, create next.config.ts:**
```typescript
import type { NextConfig } from "next";
import { withSentryConfig } from "@sentry/nextjs";

const nextConfig: NextConfig = {};

export default withSentryConfig(nextConfig, {
  org: process.env.SENTRY_ORG,
  project: process.env.SENTRY_PROJECT,
  silent: true,
  disableSourceMapUpload: process.env.NODE_ENV !== "production",
});
```

**Verify:** next.config uses withSentryConfig. Run `npm run typecheck`

**Commit:** `feat(3.2.3a): update next.config for Sentry integration`

---

### 3.2.3b Configure source maps upload

**File:** `.env.example`
**Action:** Add Sentry environment variables

**Code to add:**
```
# Sentry Error Monitoring
SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
NEXT_PUBLIC_SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
SENTRY_ORG=your-org
SENTRY_PROJECT=bank-mvp
SENTRY_AUTH_TOKEN=sntrys_xxx
```

**Note:** SENTRY_AUTH_TOKEN is only needed for source map uploads in CI/CD.

**Verify:** Environment variables documented

**Commit:** `feat(3.2.3b): configure Sentry environment variables`

---

### 3.2.4a Create error boundary component

**File:** `src/components/error-boundary.tsx`
**Action:** Create new file

**Code:**
```typescript
"use client";

import * as Sentry from "@sentry/nextjs";
import { useEffect } from "react";
import { Button } from "@/components/ui/button";

type ErrorBoundaryProps = {
  error: Error & { digest?: string };
  reset: () => void;
};

export function ErrorBoundary({ error, reset }: ErrorBoundaryProps) {
  useEffect(() => {
    // Log to Sentry
    Sentry.captureException(error);
  }, [error]);

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow text-center">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">
            Something went wrong
          </h2>
          <p className="mt-4 text-gray-600">
            We&apos;ve been notified and are working on a fix.
          </p>
          {error.digest && (
            <p className="mt-2 text-xs text-gray-400">
              Error ID: {error.digest}
            </p>
          )}
        </div>
        <div className="flex gap-4 justify-center">
          <Button onClick={reset}>Try again</Button>
          <Button variant="outline" onClick={() => (window.location.href = "/")}>
            Go home
          </Button>
        </div>
      </div>
    </div>
  );
}
```

**Verify:** Component exists and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(3.2.4a): create error boundary component with Sentry reporting`

---

### 3.2.4b Add global error page

**File:** `src/app/error.tsx`
**Action:** Create new file

**Code:**
```typescript
"use client";

import { ErrorBoundary } from "@/components/error-boundary";

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  return <ErrorBoundary error={error} reset={reset} />;
}
```

**File:** `src/app/global-error.tsx`
**Action:** Create new file (for root layout errors)

**Code:**
```typescript
"use client";

import * as Sentry from "@sentry/nextjs";
import { useEffect } from "react";

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    Sentry.captureException(error);
  }, [error]);

  return (
    <html>
      <body>
        <div style={{ padding: "2rem", textAlign: "center" }}>
          <h2>Something went wrong!</h2>
          <button onClick={reset}>Try again</button>
        </div>
      </body>
    </html>
  );
}
```

**Verify:** Error pages exist. Run `npm run typecheck`

**Commit:** `feat(3.2.4b): add global error pages with Sentry integration`

---

### 3.2.5a Add user context to Sentry errors

**File:** `src/lib/auth.ts`
**Action:** Add Sentry user context after authentication

**Add import at top:**
```typescript
import * as Sentry from "@sentry/nextjs";
```

**Update the session callback in NextAuth config:**
```typescript
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
      }
      return token;
    },
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.id as string;

        // Set Sentry user context
        Sentry.setUser({
          id: session.user.id,
          email: session.user.email || undefined,
        });
      }
      return session;
    },
  },
```

**Also clear user context on sign out. Add to auth.ts:**
```typescript
export async function signOutAndClearContext() {
  Sentry.setUser(null);
  // The actual signOut is handled by next-auth
}
```

**Verify:** Sentry receives user context with errors. Run `npm run typecheck`

**Commit:** `feat(3.2.5a): add user context to Sentry error reports`

---

## Progress Log

| Timestamp | Agent | Action | Task | Commit |
|-----------|-------|--------|------|--------|
| | | | | |
