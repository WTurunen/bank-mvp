# Feature 3.3: Test Coverage

**Track:** 3 - Reliability
**Dependencies:** 1.3 Server Validation (for schema tests)
**Estimated Tasks:** 14 atomic tasks

## Overview

Add comprehensive tests for server actions, validation schemas, and critical user flows. Target: 70% code coverage minimum.

---

## Task List

- [ ] 3.3.1a Configure test database setup
- [ ] 3.3.1b Create test utilities for database
- [ ] 3.3.2a Create invoice validation tests
- [ ] 3.3.2b Create client validation tests
- [ ] 3.3.2c Create auth validation tests
- [ ] 3.3.3a Create mock auth helper
- [ ] 3.3.3b Create createInvoice action tests
- [ ] 3.3.3c Create updateInvoice action tests
- [ ] 3.3.3d Create deleteInvoice action tests
- [ ] 3.3.4a Create createClient action tests
- [ ] 3.3.4b Create updateClient action tests
- [ ] 3.3.4c Create archiveClient action tests
- [ ] 3.3.5a Configure test coverage reporting
- [ ] 3.3.5b Add coverage threshold enforcement

---

## Task Details

### 3.3.1a Configure test database setup

**File:** `src/test/db-setup.ts`
**Action:** Create new file

**Code:**
```typescript
import { PrismaClient } from "@prisma/client";

const testDb = new PrismaClient({
  datasources: {
    db: {
      url: process.env.TEST_DATABASE_URL || process.env.DATABASE_URL,
    },
  },
});

export async function setupTestDb() {
  // Clean up tables in correct order (respecting foreign keys)
  await testDb.lineItem.deleteMany();
  await testDb.invoice.deleteMany();
  await testDb.client.deleteMany();
  await testDb.user.deleteMany();
}

export async function teardownTestDb() {
  await testDb.$disconnect();
}

export { testDb };
```

**Verify:** File exists and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(3.3.1a): configure test database setup`

---

### 3.3.1b Create test utilities for database

**File:** `src/test/factories.ts`
**Action:** Create new file

**Code:**
```typescript
import { testDb } from "./db-setup";

let userCounter = 0;
let clientCounter = 0;
let invoiceCounter = 0;

export async function createTestUser(overrides: Partial<{
  email: string;
  name: string;
  passwordHash: string;
}> = {}) {
  userCounter++;
  return testDb.user.create({
    data: {
      email: overrides.email || `test${userCounter}@example.com`,
      name: overrides.name || `Test User ${userCounter}`,
      passwordHash: overrides.passwordHash || "hashed_password",
    },
  });
}

export async function createTestClient(
  userId: string,
  overrides: Partial<{
    name: string;
    email: string;
    phone: string;
    address: string;
  }> = {}
) {
  clientCounter++;
  return testDb.client.create({
    data: {
      userId,
      name: overrides.name || `Test Client ${clientCounter}`,
      email: overrides.email || `client${clientCounter}@example.com`,
      phone: overrides.phone,
      address: overrides.address,
    },
  });
}

export async function createTestInvoice(
  userId: string,
  clientId: string,
  overrides: Partial<{
    invoiceNumber: string;
    status: string;
    dueDate: Date;
    lineItems: { description: string; quantity: number; unitPrice: number }[];
  }> = {}
) {
  invoiceCounter++;
  const client = await testDb.client.findUnique({ where: { id: clientId } });

  return testDb.invoice.create({
    data: {
      userId,
      invoiceNumber: overrides.invoiceNumber || `INV-TEST-${invoiceCounter}`,
      clientId,
      clientName: client?.name || "Test Client",
      clientEmail: client?.email || "client@test.com",
      status: overrides.status || "draft",
      dueDate: overrides.dueDate || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      lineItems: {
        create: overrides.lineItems || [
          { description: "Test Service", quantity: 1, unitPrice: 100 },
        ],
      },
    },
    include: { lineItems: true },
  });
}

export function resetCounters() {
  userCounter = 0;
  clientCounter = 0;
  invoiceCounter = 0;
}
```

**Verify:** File exists and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(3.3.1b): create test database factories`

---

### 3.3.2a Create invoice validation tests

**File:** `src/lib/schemas.test.ts`
**Action:** Create new file

**Code:**
```typescript
import { describe, it, expect } from "vitest";
import { invoiceSchema, lineItemSchema, invoiceStatusSchema } from "./schemas";

describe("lineItemSchema", () => {
  it("accepts valid line item", () => {
    const result = lineItemSchema.safeParse({
      description: "Web development",
      quantity: 10,
      unitPrice: 150,
    });
    expect(result.success).toBe(true);
  });

  it("rejects empty description", () => {
    const result = lineItemSchema.safeParse({
      description: "",
      quantity: 1,
      unitPrice: 100,
    });
    expect(result.success).toBe(false);
    if (!result.success) {
      expect(result.error.errors[0].path).toContain("description");
    }
  });

  it("rejects zero quantity", () => {
    const result = lineItemSchema.safeParse({
      description: "Service",
      quantity: 0,
      unitPrice: 100,
    });
    expect(result.success).toBe(false);
  });

  it("rejects negative quantity", () => {
    const result = lineItemSchema.safeParse({
      description: "Service",
      quantity: -1,
      unitPrice: 100,
    });
    expect(result.success).toBe(false);
  });

  it("rejects negative price", () => {
    const result = lineItemSchema.safeParse({
      description: "Service",
      quantity: 1,
      unitPrice: -50,
    });
    expect(result.success).toBe(false);
  });

  it("accepts zero price", () => {
    const result = lineItemSchema.safeParse({
      description: "Free consultation",
      quantity: 1,
      unitPrice: 0,
    });
    expect(result.success).toBe(true);
  });
});

describe("invoiceSchema", () => {
  const validInvoice = {
    clientName: "John Doe",
    clientEmail: "john@example.com",
    dueDate: "2024-12-31",
    lineItems: [{ description: "Service", quantity: 1, unitPrice: 100 }],
  };

  it("accepts valid invoice", () => {
    const result = invoiceSchema.safeParse(validInvoice);
    expect(result.success).toBe(true);
  });

  it("rejects missing client name", () => {
    const result = invoiceSchema.safeParse({
      ...validInvoice,
      clientName: "",
    });
    expect(result.success).toBe(false);
  });

  it("rejects invalid client email", () => {
    const result = invoiceSchema.safeParse({
      ...validInvoice,
      clientEmail: "not-an-email",
    });
    expect(result.success).toBe(false);
  });

  it("rejects empty line items", () => {
    const result = invoiceSchema.safeParse({
      ...validInvoice,
      lineItems: [],
    });
    expect(result.success).toBe(false);
  });

  it("accepts optional notes", () => {
    const result = invoiceSchema.safeParse({
      ...validInvoice,
      notes: "Payment due on delivery",
    });
    expect(result.success).toBe(true);
  });

  it("rejects notes exceeding max length", () => {
    const result = invoiceSchema.safeParse({
      ...validInvoice,
      notes: "a".repeat(2001),
    });
    expect(result.success).toBe(false);
  });
});

describe("invoiceStatusSchema", () => {
  it("accepts draft status", () => {
    const result = invoiceStatusSchema.safeParse("draft");
    expect(result.success).toBe(true);
  });

  it("accepts sent status", () => {
    const result = invoiceStatusSchema.safeParse("sent");
    expect(result.success).toBe(true);
  });

  it("accepts paid status", () => {
    const result = invoiceStatusSchema.safeParse("paid");
    expect(result.success).toBe(true);
  });

  it("rejects invalid status", () => {
    const result = invoiceStatusSchema.safeParse("cancelled");
    expect(result.success).toBe(false);
  });

  it("rejects empty status", () => {
    const result = invoiceStatusSchema.safeParse("");
    expect(result.success).toBe(false);
  });
});
```

**Verify:** Tests pass with `npm run test:run src/lib/schemas.test.ts`

**Commit:** `test(3.3.2a): add invoice and line item schema validation tests`

---

### 3.3.2b Create client validation tests

**File:** `src/lib/schemas.test.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
import { clientSchema } from "./schemas";

describe("clientSchema", () => {
  it("accepts valid client", () => {
    const result = clientSchema.safeParse({
      name: "Acme Corp",
      email: "contact@acme.com",
    });
    expect(result.success).toBe(true);
  });

  it("accepts client with all optional fields", () => {
    const result = clientSchema.safeParse({
      name: "Acme Corp",
      email: "contact@acme.com",
      phone: "+1-555-123-4567",
      address: "123 Main St, City, State 12345",
    });
    expect(result.success).toBe(true);
  });

  it("rejects empty name", () => {
    const result = clientSchema.safeParse({
      name: "",
      email: "contact@acme.com",
    });
    expect(result.success).toBe(false);
  });

  it("rejects name exceeding max length", () => {
    const result = clientSchema.safeParse({
      name: "a".repeat(201),
      email: "contact@acme.com",
    });
    expect(result.success).toBe(false);
  });

  it("rejects invalid email format", () => {
    const result = clientSchema.safeParse({
      name: "Acme Corp",
      email: "not-valid",
    });
    expect(result.success).toBe(false);
  });

  it("rejects email exceeding max length", () => {
    const result = clientSchema.safeParse({
      name: "Acme Corp",
      email: "a".repeat(250) + "@test.com",
    });
    expect(result.success).toBe(false);
  });

  it("accepts null phone", () => {
    const result = clientSchema.safeParse({
      name: "Acme Corp",
      email: "contact@acme.com",
      phone: null,
    });
    expect(result.success).toBe(true);
  });
});
```

**Verify:** Tests pass with `npm run test:run src/lib/schemas.test.ts`

**Commit:** `test(3.3.2b): add client schema validation tests`

---

### 3.3.2c Create auth validation tests

**File:** `src/lib/auth-validation.test.ts`
**Action:** Create new file

**Code:**
```typescript
import { describe, it, expect } from "vitest";
import { validateEmail, validatePassword, validateName } from "./auth-validation";

describe("validateEmail", () => {
  it("accepts valid email", () => {
    const result = validateEmail("user@example.com");
    expect(result.valid).toBe(true);
  });

  it("rejects empty email", () => {
    const result = validateEmail("");
    expect(result.valid).toBe(false);
    expect(result.field).toBe("email");
  });

  it("rejects invalid format", () => {
    const result = validateEmail("not-an-email");
    expect(result.valid).toBe(false);
  });

  it("rejects email without domain", () => {
    const result = validateEmail("user@");
    expect(result.valid).toBe(false);
  });
});

describe("validatePassword", () => {
  it("accepts password with 8+ characters", () => {
    const result = validatePassword("password123");
    expect(result.valid).toBe(true);
  });

  it("rejects empty password", () => {
    const result = validatePassword("");
    expect(result.valid).toBe(false);
    expect(result.field).toBe("password");
  });

  it("rejects password shorter than 8 characters", () => {
    const result = validatePassword("short");
    expect(result.valid).toBe(false);
    expect(result.message).toContain("8 characters");
  });

  it("accepts exactly 8 characters", () => {
    const result = validatePassword("12345678");
    expect(result.valid).toBe(true);
  });
});

describe("validateName", () => {
  it("accepts valid name", () => {
    const result = validateName("John Doe");
    expect(result.valid).toBe(true);
  });

  it("rejects empty name", () => {
    const result = validateName("");
    expect(result.valid).toBe(false);
  });

  it("rejects single character name", () => {
    const result = validateName("J");
    expect(result.valid).toBe(false);
    expect(result.message).toContain("2 characters");
  });

  it("accepts exactly 2 characters", () => {
    const result = validateName("Jo");
    expect(result.valid).toBe(true);
  });
});
```

**Verify:** Tests pass with `npm run test:run src/lib/auth-validation.test.ts`

**Commit:** `test(3.3.2c): add auth validation tests`

---

### 3.3.3a Create mock auth helper

**File:** `src/test/mock-auth.ts`
**Action:** Create new file

**Code:**
```typescript
import { vi } from "vitest";

type MockUser = {
  id: string;
  email: string;
  name: string;
};

let currentMockUser: MockUser | null = null;

export function setMockUser(user: MockUser | null) {
  currentMockUser = user;
}

export function getMockUser() {
  return currentMockUser;
}

export function mockAuth() {
  vi.mock("@/lib/auth", () => ({
    getCurrentUserId: vi.fn(async () => {
      const user = getMockUser();
      if (!user) {
        throw new Error("Unauthorized");
      }
      return user.id;
    }),
    auth: vi.fn(async () => {
      const user = getMockUser();
      if (!user) return null;
      return { user };
    }),
  }));
}

export function clearMockUser() {
  currentMockUser = null;
}
```

**Verify:** File exists and TypeScript compiles (`npm run typecheck`)

**Commit:** `test(3.3.3a): create mock auth helper for testing`

---

### 3.3.3b Create createInvoice action tests

**File:** `src/app/actions/invoices.test.ts`
**Action:** Create new file

**Code:**
```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from "vitest";
import { setupTestDb, teardownTestDb, testDb } from "@/test/db-setup";
import { createTestUser, createTestClient, resetCounters } from "@/test/factories";
import { setMockUser, clearMockUser } from "@/test/mock-auth";

// Mock the auth module
vi.mock("@/lib/auth", () => ({
  getCurrentUserId: vi.fn(async () => {
    const { getMockUser } = await import("@/test/mock-auth");
    const user = getMockUser();
    if (!user) throw new Error("Unauthorized");
    return user.id;
  }),
}));

// Mock revalidatePath
vi.mock("next/cache", () => ({
  revalidatePath: vi.fn(),
}));

import { createInvoice } from "./invoices";

describe("createInvoice", () => {
  let testUser: { id: string; email: string; name: string | null };
  let testClient: { id: string; name: string; email: string };

  beforeEach(async () => {
    await setupTestDb();
    resetCounters();
    testUser = await createTestUser();
    testClient = await createTestClient(testUser.id);
    setMockUser({
      id: testUser.id,
      email: testUser.email,
      name: testUser.name || "Test User",
    });
  });

  afterEach(async () => {
    clearMockUser();
    await teardownTestDb();
  });

  it("creates invoice with valid data", async () => {
    const invoiceId = await createInvoice({
      clientId: testClient.id,
      clientName: testClient.name,
      clientEmail: testClient.email,
      dueDate: "2024-12-31",
      lineItems: [
        { description: "Web development", quantity: 10, unitPrice: 150 },
      ],
    });

    expect(invoiceId).toBeDefined();

    const invoice = await testDb.invoice.findUnique({
      where: { id: invoiceId },
      include: { lineItems: true },
    });

    expect(invoice).not.toBeNull();
    expect(invoice?.clientName).toBe(testClient.name);
    expect(invoice?.status).toBe("draft");
    expect(invoice?.lineItems).toHaveLength(1);
  });

  it("generates sequential invoice numbers", async () => {
    const id1 = await createInvoice({
      clientName: "Client 1",
      clientEmail: "c1@test.com",
      dueDate: "2024-12-31",
      lineItems: [{ description: "Service", quantity: 1, unitPrice: 100 }],
    });

    const id2 = await createInvoice({
      clientName: "Client 2",
      clientEmail: "c2@test.com",
      dueDate: "2024-12-31",
      lineItems: [{ description: "Service", quantity: 1, unitPrice: 100 }],
    });

    const inv1 = await testDb.invoice.findUnique({ where: { id: id1 } });
    const inv2 = await testDb.invoice.findUnique({ where: { id: id2 } });

    expect(inv1?.invoiceNumber).toBe("INV-001");
    expect(inv2?.invoiceNumber).toBe("INV-002");
  });

  it("throws error for unauthorized user", async () => {
    clearMockUser();

    await expect(
      createInvoice({
        clientName: "Test",
        clientEmail: "test@test.com",
        dueDate: "2024-12-31",
        lineItems: [{ description: "Service", quantity: 1, unitPrice: 100 }],
      })
    ).rejects.toThrow("Unauthorized");
  });
});
```

**Note:** This test assumes Features 1.2 and 1.3 are complete. Adjust if not.

**Verify:** Tests pass with `npm run test:run src/app/actions/invoices.test.ts`

**Commit:** `test(3.3.3b): add createInvoice action tests`

---

### 3.3.3c Create updateInvoice action tests

**File:** `src/app/actions/invoices.test.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
import { updateInvoice, getInvoice } from "./invoices";
import { createTestInvoice } from "@/test/factories";

describe("updateInvoice", () => {
  let testUser: { id: string; email: string; name: string | null };
  let testClient: { id: string; name: string; email: string };
  let testInvoice: { id: string };

  beforeEach(async () => {
    await setupTestDb();
    resetCounters();
    testUser = await createTestUser();
    testClient = await createTestClient(testUser.id);
    testInvoice = await createTestInvoice(testUser.id, testClient.id);
    setMockUser({
      id: testUser.id,
      email: testUser.email,
      name: testUser.name || "Test User",
    });
  });

  afterEach(async () => {
    clearMockUser();
    await teardownTestDb();
  });

  it("updates invoice with valid data", async () => {
    await updateInvoice(testInvoice.id, {
      clientId: testClient.id,
      clientName: "Updated Name",
      clientEmail: testClient.email,
      dueDate: "2025-01-15",
      notes: "Updated notes",
      lineItems: [
        { description: "Updated service", quantity: 5, unitPrice: 200 },
      ],
    });

    const updated = await getInvoice(testInvoice.id);

    expect(updated?.clientName).toBe("Updated Name");
    expect(updated?.notes).toBe("Updated notes");
    expect(updated?.lineItems).toHaveLength(1);
    expect(updated?.lineItems[0].description).toBe("Updated service");
  });

  it("replaces all line items on update", async () => {
    await updateInvoice(testInvoice.id, {
      clientName: testClient.name,
      clientEmail: testClient.email,
      dueDate: "2025-01-15",
      lineItems: [
        { description: "New item 1", quantity: 1, unitPrice: 100 },
        { description: "New item 2", quantity: 2, unitPrice: 50 },
      ],
    });

    const updated = await getInvoice(testInvoice.id);
    expect(updated?.lineItems).toHaveLength(2);
  });

  it("throws error when updating another user invoice", async () => {
    const otherUser = await createTestUser({ email: "other@test.com" });
    const otherClient = await createTestClient(otherUser.id);
    const otherInvoice = await createTestInvoice(otherUser.id, otherClient.id);

    await expect(
      updateInvoice(otherInvoice.id, {
        clientName: "Hacked",
        clientEmail: "hacker@test.com",
        dueDate: "2025-01-15",
        lineItems: [{ description: "Hacked", quantity: 1, unitPrice: 1 }],
      })
    ).rejects.toThrow("Invoice not found");
  });
});
```

**Verify:** Tests pass with `npm run test:run src/app/actions/invoices.test.ts`

**Commit:** `test(3.3.3c): add updateInvoice action tests`

---

### 3.3.3d Create deleteInvoice action tests

**File:** `src/app/actions/invoices.test.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
import { deleteInvoice } from "./invoices";

// Mock redirect since it throws
vi.mock("next/navigation", () => ({
  redirect: vi.fn(() => {
    throw new Error("NEXT_REDIRECT");
  }),
}));

describe("deleteInvoice", () => {
  let testUser: { id: string; email: string; name: string | null };
  let testClient: { id: string };
  let testInvoice: { id: string };

  beforeEach(async () => {
    await setupTestDb();
    resetCounters();
    testUser = await createTestUser();
    testClient = await createTestClient(testUser.id);
    testInvoice = await createTestInvoice(testUser.id, testClient.id);
    setMockUser({
      id: testUser.id,
      email: testUser.email,
      name: testUser.name || "Test User",
    });
  });

  afterEach(async () => {
    clearMockUser();
    await teardownTestDb();
  });

  it("deletes invoice and its line items", async () => {
    try {
      await deleteInvoice(testInvoice.id);
    } catch (e) {
      // Redirect throws, which is expected
      if (!(e instanceof Error && e.message === "NEXT_REDIRECT")) {
        throw e;
      }
    }

    const deleted = await testDb.invoice.findUnique({
      where: { id: testInvoice.id },
    });
    expect(deleted).toBeNull();

    const lineItems = await testDb.lineItem.findMany({
      where: { invoiceId: testInvoice.id },
    });
    expect(lineItems).toHaveLength(0);
  });

  it("throws error when deleting another user invoice", async () => {
    const otherUser = await createTestUser({ email: "other@test.com" });
    const otherClient = await createTestClient(otherUser.id);
    const otherInvoice = await createTestInvoice(otherUser.id, otherClient.id);

    await expect(deleteInvoice(otherInvoice.id)).rejects.toThrow(
      "Invoice not found"
    );
  });
});
```

**Verify:** Tests pass with `npm run test:run src/app/actions/invoices.test.ts`

**Commit:** `test(3.3.3d): add deleteInvoice action tests`

---

### 3.3.4a Create createClient action tests

**File:** `src/app/actions/clients.test.ts`
**Action:** Create new file

**Code:**
```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from "vitest";
import { setupTestDb, teardownTestDb, testDb } from "@/test/db-setup";
import { createTestUser, resetCounters } from "@/test/factories";
import { setMockUser, clearMockUser, getMockUser } from "@/test/mock-auth";

vi.mock("@/lib/auth", () => ({
  getCurrentUserId: vi.fn(async () => {
    const { getMockUser } = await import("@/test/mock-auth");
    const user = getMockUser();
    if (!user) throw new Error("Unauthorized");
    return user.id;
  }),
}));

vi.mock("next/cache", () => ({
  revalidatePath: vi.fn(),
}));

import { createClient, getClient } from "./clients";

describe("createClient", () => {
  let testUser: { id: string; email: string; name: string | null };

  beforeEach(async () => {
    await setupTestDb();
    resetCounters();
    testUser = await createTestUser();
    setMockUser({
      id: testUser.id,
      email: testUser.email,
      name: testUser.name || "Test User",
    });
  });

  afterEach(async () => {
    clearMockUser();
    await teardownTestDb();
  });

  it("creates client with valid data", async () => {
    const clientId = await createClient({
      name: "Acme Corp",
      email: "contact@acme.com",
      phone: "+1-555-123-4567",
      address: "123 Main St",
    });

    expect(clientId).toBeDefined();

    const client = await getClient(clientId);
    expect(client?.name).toBe("Acme Corp");
    expect(client?.email).toBe("contact@acme.com");
  });

  it("creates client with minimal data", async () => {
    const clientId = await createClient({
      name: "Simple Corp",
      email: "simple@corp.com",
    });

    const client = await getClient(clientId);
    expect(client?.name).toBe("Simple Corp");
    expect(client?.phone).toBeNull();
  });

  it("throws error for duplicate email", async () => {
    await createClient({
      name: "First Corp",
      email: "duplicate@test.com",
    });

    await expect(
      createClient({
        name: "Second Corp",
        email: "duplicate@test.com",
      })
    ).rejects.toThrow("email already exists");
  });

  it("throws error for unauthorized user", async () => {
    clearMockUser();

    await expect(
      createClient({
        name: "Test Corp",
        email: "test@corp.com",
      })
    ).rejects.toThrow("Unauthorized");
  });
});
```

**Verify:** Tests pass with `npm run test:run src/app/actions/clients.test.ts`

**Commit:** `test(3.3.4a): add createClient action tests`

---

### 3.3.4b Create updateClient action tests

**File:** `src/app/actions/clients.test.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
import { updateClient } from "./clients";
import { createTestClient } from "@/test/factories";

describe("updateClient", () => {
  let testUser: { id: string; email: string; name: string | null };
  let testClient: { id: string };

  beforeEach(async () => {
    await setupTestDb();
    resetCounters();
    testUser = await createTestUser();
    testClient = await createTestClient(testUser.id);
    setMockUser({
      id: testUser.id,
      email: testUser.email,
      name: testUser.name || "Test User",
    });
  });

  afterEach(async () => {
    clearMockUser();
    await teardownTestDb();
  });

  it("updates client with valid data", async () => {
    await updateClient(testClient.id, {
      name: "Updated Name",
      email: "updated@test.com",
      phone: "+1-555-999-8888",
    });

    const updated = await getClient(testClient.id);
    expect(updated?.name).toBe("Updated Name");
    expect(updated?.email).toBe("updated@test.com");
    expect(updated?.phone).toBe("+1-555-999-8888");
  });

  it("throws error when updating another user client", async () => {
    const otherUser = await createTestUser({ email: "other@test.com" });
    const otherClient = await createTestClient(otherUser.id, {
      email: "other-client@test.com",
    });

    await expect(
      updateClient(otherClient.id, {
        name: "Hacked",
        email: "hacker@test.com",
      })
    ).rejects.toThrow("Client not found");
  });
});
```

**Verify:** Tests pass with `npm run test:run src/app/actions/clients.test.ts`

**Commit:** `test(3.3.4b): add updateClient action tests`

---

### 3.3.4c Create archiveClient action tests

**File:** `src/app/actions/clients.test.ts`
**Action:** Add to existing file

**Code to add:**
```typescript
import { archiveClient, restoreClient, getClients } from "./clients";

describe("archiveClient", () => {
  let testUser: { id: string; email: string; name: string | null };
  let testClient: { id: string };

  beforeEach(async () => {
    await setupTestDb();
    resetCounters();
    testUser = await createTestUser();
    testClient = await createTestClient(testUser.id);
    setMockUser({
      id: testUser.id,
      email: testUser.email,
      name: testUser.name || "Test User",
    });
  });

  afterEach(async () => {
    clearMockUser();
    await teardownTestDb();
  });

  it("archives client", async () => {
    await archiveClient(testClient.id);

    const archived = await getClient(testClient.id);
    expect(archived?.archivedAt).not.toBeNull();
  });

  it("hides archived client from default list", async () => {
    await archiveClient(testClient.id);

    const { data: clients } = await getClients(false);
    expect(clients.find((c) => c.id === testClient.id)).toBeUndefined();
  });

  it("shows archived client when includeArchived is true", async () => {
    await archiveClient(testClient.id);

    const { data: clients } = await getClients(true);
    expect(clients.find((c) => c.id === testClient.id)).toBeDefined();
  });

  it("restores archived client", async () => {
    await archiveClient(testClient.id);
    await restoreClient(testClient.id);

    const restored = await getClient(testClient.id);
    expect(restored?.archivedAt).toBeNull();
  });
});
```

**Verify:** Tests pass with `npm run test:run src/app/actions/clients.test.ts`

**Commit:** `test(3.3.4c): add archiveClient and restoreClient action tests`

---

### 3.3.5a Configure test coverage reporting

**File:** `vitest.config.ts`
**Action:** Add coverage configuration

**Find the vitest config and add coverage settings:**
```typescript
import { defineConfig } from "vitest/config";
import react from "@vitejs/plugin-react";
import path from "path";

export default defineConfig({
  plugins: [react()],
  test: {
    environment: "happy-dom",
    setupFiles: ["./src/test/setup.ts"],
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
      include: ["src/**/*.{ts,tsx}"],
      exclude: [
        "src/**/*.test.{ts,tsx}",
        "src/test/**",
        "src/components/ui/**",
      ],
    },
  },
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
});
```

**Verify:** Run `npm run test:run -- --coverage` and see coverage report

**Commit:** `feat(3.3.5a): configure test coverage reporting`

---

### 3.3.5b Add coverage threshold enforcement

**File:** `vitest.config.ts`
**Action:** Add coverage thresholds

**Add to the coverage config:**
```typescript
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
      include: ["src/**/*.{ts,tsx}"],
      exclude: [
        "src/**/*.test.{ts,tsx}",
        "src/test/**",
        "src/components/ui/**",
      ],
      thresholds: {
        lines: 70,
        functions: 70,
        branches: 70,
        statements: 70,
      },
    },
```

**Update package.json to add coverage script:**
```json
"scripts": {
  "test:coverage": "vitest run --coverage"
}
```

**Verify:** `npm run test:coverage` fails if coverage is below 70%

**Commit:** `feat(3.3.5b): add 70% coverage threshold enforcement`

---

## Progress Log

| Timestamp | Agent | Action | Task | Commit |
|-----------|-------|--------|------|--------|
| | | | | |
