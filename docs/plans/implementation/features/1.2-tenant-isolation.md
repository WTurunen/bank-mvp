# Feature 1.2: Tenant Isolation

**Track:** 1 - Security (BLOCKING)
**Dependencies:** 1.1 Authentication (must be complete)
**Estimated Tasks:** 14 atomic tasks

## Overview

Add `userId` to all data models and enforce tenant isolation in all queries. Users can only see and modify their own data.

---

## Task List

- [ ] 1.2.1a Add userId field to Client model
- [ ] 1.2.1b Add userId field to Invoice model
- [ ] 1.2.1c Add foreign key relation to User model
- [ ] 1.2.2a Run prisma db push for userId fields
- [ ] 1.2.2b Run prisma generate
- [ ] 1.2.3a Create getCurrentUserId helper function
- [ ] 1.2.4a Update createClient to include userId
- [ ] 1.2.4b Update getClients to filter by userId
- [ ] 1.2.4c Update getClient to filter by userId
- [ ] 1.2.4d Update updateClient to verify ownership
- [ ] 1.2.4e Update archiveClient to verify ownership
- [ ] 1.2.5a Update createInvoice to include userId
- [ ] 1.2.5b Update getInvoices to filter by userId
- [ ] 1.2.5c Update getInvoice to filter by userId
- [ ] 1.2.5d Update updateInvoice to verify ownership
- [ ] 1.2.5e Update deleteInvoice to verify ownership

---

## Task Details

### 1.2.1a Add userId field to Client model

**File:** `prisma/schema.prisma`
**Action:** Modify Client model

**Find this code:**
```prisma
model Client {
  id          String    @id @default(cuid())
  name        String
```

**Replace with:**
```prisma
model Client {
  id          String    @id @default(cuid())
  userId      String
  name        String
```

**Verify:** Client model has userId field

**Commit:** `feat(1.2.1a): add userId field to Client model`

---

### 1.2.1b Add userId field to Invoice model

**File:** `prisma/schema.prisma`
**Action:** Modify Invoice model

**Find this code:**
```prisma
model Invoice {
  id            String     @id @default(cuid())
  invoiceNumber String     @unique
```

**Replace with:**
```prisma
model Invoice {
  id            String     @id @default(cuid())
  userId        String
  invoiceNumber String     @unique
```

**Verify:** Invoice model has userId field

**Commit:** `feat(1.2.1b): add userId field to Invoice model`

---

### 1.2.1c Add foreign key relation to User model

**File:** `prisma/schema.prisma`
**Action:** Modify User model to add relations

**Find this code:**
```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
```

**Replace with:**
```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  clients       Client[]
  invoices      Invoice[]
}
```

**Also add to Client model (after userId):**
```prisma
  user        User      @relation(fields: [userId], references: [id])
```

**Also add to Invoice model (after userId):**
```prisma
  user          User       @relation(fields: [userId], references: [id])
```

**Verify:** All three models have proper relations defined

**Commit:** `feat(1.2.1c): add User relations to Client and Invoice models`

---

### 1.2.2a Run prisma db push for userId fields

**Action:** Run command
**Command:**
```bash
npx prisma db push
```

**Note:** This will fail if there is existing data without userId. For development, you may need to:
```bash
npx prisma db push --force-reset
```

**Verify:** Command completes without errors

**Commit:** `feat(1.2.2a): apply userId fields to database schema`

---

### 1.2.2b Run prisma generate

**Action:** Run command
**Command:**
```bash
npx prisma generate
```
**Verify:** Command completes without errors

**Commit:** No commit needed (generated files are gitignored)

---

### 1.2.3a Create getCurrentUserId helper function

**File:** `src/lib/auth.ts`
**Action:** Add function at end of file

**Code to add:**
```typescript
export async function getCurrentUserId(): Promise<string> {
  const session = await auth();

  if (!session?.user?.id) {
    throw new Error("Unauthorized");
  }

  return session.user.id;
}
```

**Verify:** Function exists and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(1.2.3a): create getCurrentUserId helper function`

---

### 1.2.4a Update createClient to include userId

**File:** `src/app/actions/clients.ts`
**Action:** Modify createClient function

**Add import at top:**
```typescript
import { getCurrentUserId } from "@/lib/auth";
```

**Find this code in createClient:**
```typescript
export async function createClient(data: ClientInput): Promise<string> {
  try {
    const client = await db.client.create({
      data: {
        name: data.name,
```

**Replace with:**
```typescript
export async function createClient(data: ClientInput): Promise<string> {
  const userId = await getCurrentUserId();

  try {
    const client = await db.client.create({
      data: {
        userId,
        name: data.name,
```

**Verify:** createClient includes userId in the data object. Run `npm run typecheck`

**Commit:** `feat(1.2.4a): add userId to createClient action`

---

### 1.2.4b Update getClients to filter by userId

**File:** `src/app/actions/clients.ts`
**Action:** Modify getClients function

**Find this code:**
```typescript
export async function getClients(includeArchived = false) {
  return db.client.findMany({
    where: includeArchived ? {} : { archivedAt: null },
```

**Replace with:**
```typescript
export async function getClients(includeArchived = false) {
  const userId = await getCurrentUserId();

  return db.client.findMany({
    where: {
      userId,
      ...(includeArchived ? {} : { archivedAt: null }),
    },
```

**Verify:** getClients filters by userId. Run `npm run typecheck`

**Commit:** `feat(1.2.4b): filter getClients by userId`

---

### 1.2.4c Update getClient to filter by userId

**File:** `src/app/actions/clients.ts`
**Action:** Modify getClient function

**Find this code:**
```typescript
export async function getClient(id: string) {
  return db.client.findUnique({
    where: { id },
```

**Replace with:**
```typescript
export async function getClient(id: string) {
  const userId = await getCurrentUserId();

  return db.client.findFirst({
    where: { id, userId },
```

**Note:** Changed from `findUnique` to `findFirst` because we need to filter by both id and userId

**Verify:** getClient filters by userId. Run `npm run typecheck`

**Commit:** `feat(1.2.4c): filter getClient by userId`

---

### 1.2.4d Update updateClient to verify ownership

**File:** `src/app/actions/clients.ts`
**Action:** Modify updateClient function

**Find this code:**
```typescript
export async function updateClient(id: string, data: ClientInput) {
  try {
    await db.client.update({
      where: { id },
```

**Replace with:**
```typescript
export async function updateClient(id: string, data: ClientInput) {
  const userId = await getCurrentUserId();

  // Verify ownership
  const existing = await db.client.findFirst({
    where: { id, userId },
  });

  if (!existing) {
    throw new Error("Client not found");
  }

  try {
    await db.client.update({
      where: { id },
```

**Verify:** updateClient verifies ownership before updating. Run `npm run typecheck`

**Commit:** `feat(1.2.4d): verify ownership in updateClient`

---

### 1.2.4e Update archiveClient to verify ownership

**File:** `src/app/actions/clients.ts`
**Action:** Modify archiveClient function

**Find this code:**
```typescript
export async function archiveClient(id: string) {
  await db.client.update({
```

**Replace with:**
```typescript
export async function archiveClient(id: string) {
  const userId = await getCurrentUserId();

  // Verify ownership
  const existing = await db.client.findFirst({
    where: { id, userId },
  });

  if (!existing) {
    throw new Error("Client not found");
  }

  await db.client.update({
```

**Also update restoreClient with the same pattern.**

**Verify:** archiveClient and restoreClient verify ownership. Run `npm run typecheck`

**Commit:** `feat(1.2.4e): verify ownership in archiveClient and restoreClient`

---

### 1.2.5a Update createInvoice to include userId

**File:** `src/app/actions/invoices.ts`
**Action:** Modify createInvoice function

**Add import at top:**
```typescript
import { getCurrentUserId } from "@/lib/auth";
```

**Find this code in createInvoice:**
```typescript
  const invoice = await db.invoice.create({
    data: {
      invoiceNumber,
      clientId: data.clientId,
```

**Replace with:**
```typescript
  const userId = await getCurrentUserId();

  const invoice = await db.invoice.create({
    data: {
      userId,
      invoiceNumber,
      clientId: data.clientId,
```

**Verify:** createInvoice includes userId. Run `npm run typecheck`

**Commit:** `feat(1.2.5a): add userId to createInvoice action`

---

### 1.2.5b Update getInvoices to filter by userId

**File:** `src/app/actions/invoices.ts`
**Action:** Modify getInvoices function

**Find this code:**
```typescript
export async function getInvoices(clientId?: string) {
  const invoices = await db.invoice.findMany({
    where: clientId ? { clientId } : {},
```

**Replace with:**
```typescript
export async function getInvoices(clientId?: string) {
  const userId = await getCurrentUserId();

  const invoices = await db.invoice.findMany({
    where: {
      userId,
      ...(clientId ? { clientId } : {}),
    },
```

**Verify:** getInvoices filters by userId. Run `npm run typecheck`

**Commit:** `feat(1.2.5b): filter getInvoices by userId`

---

### 1.2.5c Update getInvoice to filter by userId

**File:** `src/app/actions/invoices.ts`
**Action:** Modify getInvoice function

**Find this code:**
```typescript
export async function getInvoice(id: string) {
  const invoice = await db.invoice.findUnique({
    where: { id },
```

**Replace with:**
```typescript
export async function getInvoice(id: string) {
  const userId = await getCurrentUserId();

  const invoice = await db.invoice.findFirst({
    where: { id, userId },
```

**Note:** Changed from `findUnique` to `findFirst` because we need to filter by both id and userId

**Verify:** getInvoice filters by userId. Run `npm run typecheck`

**Commit:** `feat(1.2.5c): filter getInvoice by userId`

---

### 1.2.5d Update updateInvoice to verify ownership

**File:** `src/app/actions/invoices.ts`
**Action:** Modify updateInvoice function

**Find this code:**
```typescript
export async function updateInvoice(id: string, data: InvoiceInput) {
  await db.lineItem.deleteMany({ where: { invoiceId: id } });
```

**Replace with:**
```typescript
export async function updateInvoice(id: string, data: InvoiceInput) {
  const userId = await getCurrentUserId();

  // Verify ownership
  const existing = await db.invoice.findFirst({
    where: { id, userId },
  });

  if (!existing) {
    throw new Error("Invoice not found");
  }

  await db.lineItem.deleteMany({ where: { invoiceId: id } });
```

**Verify:** updateInvoice verifies ownership. Run `npm run typecheck`

**Commit:** `feat(1.2.5d): verify ownership in updateInvoice`

---

### 1.2.5e Update deleteInvoice to verify ownership

**File:** `src/app/actions/invoices.ts`
**Action:** Modify deleteInvoice function

**Find this code:**
```typescript
export async function deleteInvoice(id: string) {
  await db.invoice.delete({ where: { id } });
```

**Replace with:**
```typescript
export async function deleteInvoice(id: string) {
  const userId = await getCurrentUserId();

  // Verify ownership
  const existing = await db.invoice.findFirst({
    where: { id, userId },
  });

  if (!existing) {
    throw new Error("Invoice not found");
  }

  await db.invoice.delete({ where: { id } });
```

**Also update updateInvoiceStatus with the same ownership check pattern.**

**Verify:** deleteInvoice and updateInvoiceStatus verify ownership. Run `npm run typecheck`

**Commit:** `feat(1.2.5e): verify ownership in deleteInvoice and updateInvoiceStatus`

---

## Progress Log

| Timestamp | Agent | Action | Task | Commit |
|-----------|-------|--------|------|--------|
| | | | | |
