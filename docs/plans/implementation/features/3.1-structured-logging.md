# Feature 3.1: Structured Logging

**Track:** 3 - Reliability
**Dependencies:** None
**Estimated Tasks:** 10 atomic tasks

## Overview

Add structured logging with Pino for debugging, monitoring, and audit trails. Logs should include request context, user IDs, and action results.

---

## Task List

- [ ] 3.1.1a Install pino dependency
- [ ] 3.1.1b Install pino-pretty for development
- [ ] 3.1.2a Create logger utility
- [ ] 3.1.2b Configure log levels by environment
- [ ] 3.1.3a Add logging to createInvoice
- [ ] 3.1.3b Add logging to updateInvoice
- [ ] 3.1.3c Add logging to deleteInvoice
- [ ] 3.1.4a Add logging to client actions
- [ ] 3.1.5a Create request logging middleware
- [ ] 3.1.5b Add error logging utility

---

## Task Details

### 3.1.1a Install pino dependency

**Action:** Run command
**Command:**
```bash
npm install pino
```
**Verify:**
```bash
npm ls pino
```
Should show `pino@8.x.x` or `pino@9.x.x`

**Commit:** `feat(3.1.1a): install pino logging library`

---

### 3.1.1b Install pino-pretty for development

**Action:** Run command
**Command:**
```bash
npm install -D pino-pretty
```
**Verify:**
```bash
npm ls pino-pretty
```
Should show `pino-pretty@10.x.x` or similar

**Commit:** `feat(3.1.1b): install pino-pretty for development logging`

---

### 3.1.2a Create logger utility

**File:** `src/lib/logger.ts`
**Action:** Create new file

**Code:**
```typescript
import pino from "pino";

const isDevelopment = process.env.NODE_ENV === "development";

export const logger = pino({
  level: process.env.LOG_LEVEL || (isDevelopment ? "debug" : "info"),
  transport: isDevelopment
    ? {
        target: "pino-pretty",
        options: {
          colorize: true,
          translateTime: "SYS:standard",
          ignore: "pid,hostname",
        },
      }
    : undefined,
  base: {
    env: process.env.NODE_ENV,
  },
});

export type LogContext = {
  userId?: string;
  action?: string;
  invoiceId?: string;
  clientId?: string;
  [key: string]: unknown;
};

export function createLogger(context: LogContext) {
  return logger.child(context);
}
```

**Verify:** File exists and TypeScript compiles (`npm run typecheck`)

**Commit:** `feat(3.1.2a): create Pino logger utility`

---

### 3.1.2b Configure log levels by environment

**File:** `.env.example`
**Action:** Add LOG_LEVEL variable (create file if it doesn't exist)

**Code to add:**
```
# Logging
LOG_LEVEL=debug  # Options: trace, debug, info, warn, error, fatal
```

**File:** `src/lib/logger.ts`
**Action:** Already configured in previous task

**Log levels:**
- `trace`: Most verbose, for debugging specific issues
- `debug`: Development debugging
- `info`: Production default, important events
- `warn`: Potential issues
- `error`: Errors that need attention
- `fatal`: System cannot continue

**Verify:** LOG_LEVEL environment variable is documented

**Commit:** `feat(3.1.2b): configure log levels by environment`

---

### 3.1.3a Add logging to createInvoice

**File:** `src/app/actions/invoices.ts`
**Action:** Add logging to createInvoice function

**Add import at top:**
```typescript
import { createLogger } from "@/lib/logger";
```

**Modify createInvoice to add logging:**
```typescript
export async function createInvoice(data: InvoiceInput) {
  const userId = await getCurrentUserId();
  const log = createLogger({ action: "createInvoice", userId });

  log.info({ clientName: data.clientName }, "Creating invoice");

  // ... validation code ...

  const invoiceNumber = await generateInvoiceNumber();

  try {
    const invoice = await db.invoice.create({
      // ... existing code ...
    });

    log.info({ invoiceId: invoice.id, invoiceNumber }, "Invoice created successfully");

    revalidatePath("/");
    return invoice.id;
  } catch (error) {
    log.error({ error, clientName: data.clientName }, "Failed to create invoice");
    throw error;
  }
}
```

**Note:** If tenant isolation (1.2) is not yet done, get userId a different way or omit it.

**Verify:** createInvoice logs actions. Run `npm run typecheck`

**Commit:** `feat(3.1.3a): add structured logging to createInvoice`

---

### 3.1.3b Add logging to updateInvoice

**File:** `src/app/actions/invoices.ts`
**Action:** Add logging to updateInvoice function

**Modify updateInvoice to add logging:**
```typescript
export async function updateInvoice(id: string, data: InvoiceInput) {
  const userId = await getCurrentUserId();
  const log = createLogger({ action: "updateInvoice", userId, invoiceId: id });

  log.info("Updating invoice");

  // ... validation and ownership check code ...

  try {
    await db.lineItem.deleteMany({ where: { invoiceId: id } });

    await db.invoice.update({
      // ... existing code ...
    });

    log.info("Invoice updated successfully");

    revalidatePath("/");
    revalidatePath(`/invoices/${id}`);
  } catch (error) {
    log.error({ error }, "Failed to update invoice");
    throw error;
  }
}
```

**Verify:** updateInvoice logs actions. Run `npm run typecheck`

**Commit:** `feat(3.1.3b): add structured logging to updateInvoice`

---

### 3.1.3c Add logging to deleteInvoice

**File:** `src/app/actions/invoices.ts`
**Action:** Add logging to deleteInvoice function

**Modify deleteInvoice to add logging:**
```typescript
export async function deleteInvoice(id: string) {
  const userId = await getCurrentUserId();
  const log = createLogger({ action: "deleteInvoice", userId, invoiceId: id });

  log.info("Deleting invoice");

  // ... ownership check code ...

  try {
    await db.invoice.delete({ where: { id } });

    log.info("Invoice deleted successfully");

    revalidatePath("/");
    redirect("/");
  } catch (error) {
    log.error({ error }, "Failed to delete invoice");
    throw error;
  }
}
```

**Also add logging to updateInvoiceStatus:**
```typescript
export async function updateInvoiceStatus(id: string, status: string) {
  const userId = await getCurrentUserId();
  const log = createLogger({ action: "updateInvoiceStatus", userId, invoiceId: id });

  log.info({ newStatus: status }, "Updating invoice status");

  // ... validation code ...

  try {
    await db.invoice.update({
      where: { id },
      data: { status },
    });

    log.info({ status }, "Invoice status updated successfully");

    revalidatePath("/");
    revalidatePath(`/invoices/${id}`);
  } catch (error) {
    log.error({ error, status }, "Failed to update invoice status");
    throw error;
  }
}
```

**Verify:** deleteInvoice and updateInvoiceStatus log actions. Run `npm run typecheck`

**Commit:** `feat(3.1.3c): add structured logging to deleteInvoice and updateInvoiceStatus`

---

### 3.1.4a Add logging to client actions

**File:** `src/app/actions/clients.ts`
**Action:** Add logging to all client actions

**Add import at top:**
```typescript
import { createLogger } from "@/lib/logger";
```

**Add logging to createClient:**
```typescript
export async function createClient(data: ClientInput): Promise<string> {
  const userId = await getCurrentUserId();
  const log = createLogger({ action: "createClient", userId });

  log.info({ clientEmail: data.email }, "Creating client");

  // ... validation code ...

  try {
    const client = await db.client.create({
      // ... existing code ...
    });

    log.info({ clientId: client.id }, "Client created successfully");

    // ... revalidatePath calls ...
    return client.id;
  } catch (error: unknown) {
    if (/* P2002 check */) {
      log.warn({ email: data.email }, "Duplicate client email");
      throw new Error("A client with this email already exists");
    }
    log.error({ error }, "Failed to create client");
    throw error;
  }
}
```

**Add similar logging to updateClient, archiveClient, and restoreClient.**

**Verify:** All client actions log their operations. Run `npm run typecheck`

**Commit:** `feat(3.1.4a): add structured logging to client actions`

---

### 3.1.5a Create request logging middleware

**File:** `src/lib/logger.ts`
**Action:** Add request logging helper

**Code to add:**
```typescript
export function logRequest(
  method: string,
  path: string,
  statusCode: number,
  durationMs: number,
  userId?: string
) {
  const log = createLogger({ userId });

  if (statusCode >= 500) {
    log.error({ method, path, statusCode, durationMs }, "Request failed");
  } else if (statusCode >= 400) {
    log.warn({ method, path, statusCode, durationMs }, "Request client error");
  } else {
    log.info({ method, path, statusCode, durationMs }, "Request completed");
  }
}
```

**File:** `src/middleware.ts`
**Action:** Add request timing (optional, can skip if too complex)

**This is optional. Server actions already log their own operations.**

**Verify:** Request logging helper exists. Run `npm run typecheck`

**Commit:** `feat(3.1.5a): create request logging helper`

---

### 3.1.5b Add error logging utility

**File:** `src/lib/logger.ts`
**Action:** Add error logging helper

**Code to add:**
```typescript
export function logError(
  error: unknown,
  context: LogContext & { message?: string }
) {
  const log = createLogger(context);

  if (error instanceof Error) {
    log.error(
      {
        errorName: error.name,
        errorMessage: error.message,
        stack: error.stack,
      },
      context.message || "An error occurred"
    );
  } else {
    log.error({ error }, context.message || "An unknown error occurred");
  }
}
```

**Verify:** Error logging helper exists. Run `npm run typecheck`

**Commit:** `feat(3.1.5b): add error logging utility`

---

## Progress Log

| Timestamp | Agent | Action | Task | Commit |
|-----------|-------|--------|------|--------|
| | | | | |
